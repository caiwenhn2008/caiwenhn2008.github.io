---
layout:     post
title:      Jmockit介绍实战
subtitle:   Jmockit介绍实战
date:       2019-11-14
author:     BY
header-img: img/post-bg-debug.png
catalog: true
tags:
    - Jmockit
---


> Jmockit介绍实战

单元测试（UT: Unit Test）是保证服务质量的基础。在实际项目的 UT 开发中，我们通常需要执行第三方服务调用、连接数据库等操作，为了让 UT 能够正常运行起来，我们需要执行大量的环境准备工作，这些工作有时比 UT 本身还要费时费力很多，而 mock 机制则能够帮助我们绕开这些必要但不一定要真正需要去做的事情，隔离 UT 与服务的依赖，模拟我们期望的行为和数据。

## 录制 & 重放 & 验证
 录制（record）、重放（replay）和验证（verify）是 JMockit 的设计哲学（下文如果不做特殊说明，均使用 RRV 进行指代），这三个步骤各自所担负的责任如下：

- 录制：录制目标方法的期望行为，依据条件返回期望的数据，或者抛出异常
- 重放：当执行测试逻辑时，之前录制的行为会被触发，所谓的重放是应用之前录制的行为
- 验证：验证被测试逻辑的实际表现，例如期望的方法是否被调用，实际被调用了几次等

实际在日常使用 JUnit 进行 UT 开发时，我们通常也是按照录制、重放、验证这样一个步骤进行的，只不过我们称之为 “Arrange-Act-Assert”，3A 理论与 RRV 本质上是一样的。

	@Test
	public void test() {
    // 1. 录制
    new Expectations() {
        {
            // 录制我们期望的目标方法行为
        }
    };

    // 2. 重放：执行测试逻辑

    // 3. 验证
    new Verifications() {
        {
            // 验证目标方法的执行状态
        }
    };
	}

使用 JMockit 进行实际 UT 开发时，并不要求同时提供这 3 个步骤实现，一般我们常用的是录制和重放，而业务相关的验证逻辑可以使用断言。

### 录制 Expectations
Expectations 代码块用于放置录制行为，录制主要分为两种方式：

- 引用外部 mock 类或接口实例进行录制
- 通过构造方法注入类或对象实例进行录制
  
#### 引用外部 mock 类或接口实例进行录制
	@Mocked
	private UserService userService;

	@Test
	public void recordByMockedInstance() {
    new Expectations() {
        {
            userService.getUserName(anyLong);
            result = "zhenchao";

            userService.getUserAge(anyLong);
            result = 28;
        }
    };
		Assert.assertEquals("zhenchao", userService.getUserName(1001L));
		Assert.assertEquals(28, userService.getUserAge(1002L));
	}


#### 通过构造方法注入类或对象实例进行录制
Expectations 提供了带参数的构造方法（定义如下），我们可以将一个类的 Class 对象，或者类实例对象作为参数构造 Expectations 对象，区别在于如果传递的是类 Class 对象则录制会对该类的所有实例生效，如果传递的是类实例对象则仅对当前实例生效。

	protected Expectations(@Nonnull Object... classesOrObjectsToBePartiallyMocked) {
		execution = new RecordAndReplayExecution(this, classesOrObjectsToBePartiallyMocked);
	}

以类 Class 对象构造 Expectations

	@Test
	public void recordByClass() {
		User user = new User(1001L);
		new Expectations(User.class) {
			{
				user.getName();
				result = "zhenchao";

				user.getAge();
				result = 28;
			}
		};

		Assert.assertEquals("zhenchao", user.getName());
		Assert.assertEquals(28, user.getAge());

		// 对其它实例同样生效
		User user2 = new User(1002L, "zhangsan", 18);
		Assert.assertEquals("zhenchao", user2.getName());
		Assert.assertEquals(28, user2.getAge());
	}

以类对象实例构造 Expectations

	@Test
	public void recordByInstance() {
		User user = new User(1001L);
		new Expectations(user) {
			{
				user.getName();
				result = "zhenchao";

				user.getAge();
				result = 28;
			}
		};

		Assert.assertEquals("zhenchao", user.getName());
		Assert.assertEquals(28, user.getAge());

		// 对其它实例不生效
		User user2 = new User(1002L, "zhangsan", 18);
		Assert.assertEquals("zhangsan", user2.getName());
		Assert.assertEquals(18, user2.getAge());
	}

